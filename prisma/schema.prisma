// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  isAdmin   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stockMovements StockMovement[]
  sales          Sale[]
  stockOpnames   StockOpname[]
}

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  description String?
  category    String?
  buyPrice    Float?    @map("buy_price")
  sellingPrice Float    @map("selling_price")
  stock       Int      @default(0)
  imagePath   String?  @map("image_path")
  dateIn      DateTime? @map("date_in")
  dateOut     DateTime? @map("date_out")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  stockMovements StockMovement[]
  saleItems      SaleItem[]
  stockOpnameItems StockOpnameItem[]
}

model StockMovement {
  id            String   @id @default(cuid())
  productId     String   @map("product_id")
  type          MovementType
  qty           Int
  note          String?
  referenceType String?  @map("reference_type")
  referenceId   String?  @map("reference_id")
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [createdBy], references: [id])
}

model Sale {
  id           String      @id @default(cuid())
  invoiceNo    String      @unique @map("invoice_no")
  totalAmount  Float       @map("total_amount")
  paymentMethod PaymentMethod @map("payment_method")
  paidAmount   Float?      @map("paid_amount")
  changeAmount Float?      @map("change_amount")
  createdBy    String      @map("created_by")
  createdAt    DateTime    @default(now()) @map("created_at")

  // Relations
  user  User       @relation(fields: [createdBy], references: [id])
  items SaleItem[]
}

model SaleItem {
  id        String  @id @default(cuid())
  saleId    String  @map("sale_id")
  productId String  @map("product_id")
  qty       Int
  unitPrice Float   @map("unit_price")
  subtotal  Float

  // Relations
  sale    Sale    @relation(fields: [saleId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model StockOpname {
  id          String   @id @default(cuid())
  performedBy String   @map("performed_by")
  date        DateTime @default(now())
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user  User              @relation(fields: [performedBy], references: [id])
  items StockOpnameItem[]
}

model StockOpnameItem {
  id              String @id @default(cuid())
  stockOpnameId   String @map("stock_opname_id")
  productId       String @map("product_id")
  countedQty      Int    @map("counted_qty")
  systemQty       Int    @map("system_qty")
  diff            Int

  // Relations
  stockOpname StockOpname @relation(fields: [stockOpnameId], references: [id])
  product     Product     @relation(fields: [productId], references: [id])
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

enum MovementType {
  IN
  OUT
  ADJUST
}

enum PaymentMethod {
  CASH
  TRANSFER
}